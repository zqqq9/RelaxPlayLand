<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game | RelaxPlayLand</title>
    <meta name="description" content="Play relaxing games on RelaxPlayLand">
    <meta name="keywords" content="games, relaxing, online games">
    <meta name="author" content="RelaxPlayLand">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://relaxplayland.online/game-template.html">
    
    <!-- Open Graph Meta Tags (will be updated dynamically) -->
    <meta property="og:title" content="Game | RelaxPlayLand">
    <meta property="og:description" content="Play relaxing games on RelaxPlayLand">
    <meta property="og:url" content="https://relaxplayland.online/game-template.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="RelaxPlayLand">
    
    <!-- Twitter Card Meta Tags (will be updated dynamically) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Game | RelaxPlayLand">
    <meta name="twitter:description" content="Play relaxing games on RelaxPlayLand">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">
    
    <style>
        .game-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        @media (max-width: 768px) {
            .game-iframe {
                height: 400px;
            }
        }
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-difficulty-easy {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .badge-difficulty-medium {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .badge-difficulty-hard {
            background-color: #FEE2E2;
            color: #B91C1C;
        }
        .game-fallback {
            display: none;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            border-radius: 8px;
        }
        .game-fallback h3 {
            color: #4B5563;
            margin-bottom: 10px;
        }
        .game-fallback p {
            color: #6B7280;
            margin-bottom: 15px;
        }
        .game-fallback a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #3B82F6;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: #FEE2E2;
            border-radius: 8px;
            color: #B91C1C;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">RelaxPlayLand</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</a>
                        <a href="/#games" class="text-blue-600 hover:text-blue-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Games</a>
                        <a href="/#about" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">About</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading state -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading game data...</p>
        </div>
        
        <!-- Error message -->
        <div id="error-message" class="error-message">
            <h2 class="text-xl font-bold mb-2">Game Not Found</h2>
            <p>Sorry, we couldn't find the game you're looking for.</p>
            <a href="/" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                Return to Home
            </a>
        </div>
        
        <!-- Game content (initially hidden) -->
        <div id="game-content" class="bg-white rounded-lg shadow-lg overflow-hidden" style="display: none;">
            <!-- Game Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 id="game-title" class="text-3xl font-bold text-gray-800">Game Title</h1>
                        <div id="game-badges" class="flex flex-wrap items-center mt-2 space-x-2">
                            <!-- Badges will be inserted here -->
                        </div>
                    </div>
                    <a href="/" class="mt-4 md:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Games
                    </a>
                </div>
            </div>

            <!-- Game Content -->
            <div class="p-6">
                <!-- Game Iframe -->
                <div class="bg-gray-800 rounded-lg overflow-hidden mb-8">
                    <iframe id="game-iframe" src="" class="game-iframe" title="Game" allowfullscreen frameborder="0"></iframe>
                    <!-- Fallback content if game fails to load -->
                    <div id="game-fallback" class="game-fallback">
                        <h3>Game Loading Issue</h3>
                        <p>Sorry, the game couldn't be loaded properly. Please try one of these options:</p>
                        <div class="space-y-3">
                            <a id="new-window-link" href="#" target="_blank" class="inline-block">Play in New Window</a>
                            <p>or</p>
                            <button id="reload-game" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Reload Game</button>
                        </div>
                    </div>
                </div>

                <!-- Game Info -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">About This Game</h2>
                        <p id="game-description" class="text-gray-600 mb-6">Game description will be loaded here.</p>
                        
                        <h3 class="text-xl font-bold mb-3 text-gray-800">How to Play</h3>
                        <p id="game-instructions" class="text-gray-600 mb-6">Game instructions will be loaded here.</p>
                        
                        <h3 class="text-xl font-bold mb-3 text-gray-800">Features</h3>
                        <p id="game-features" class="text-gray-600 mb-6">Game features will be loaded here.</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Game Details</h3>
                        <ul class="space-y-3">
                            <li class="flex justify-between">
                                <span class="text-gray-600">Category:</span>
                                <span id="game-category" class="font-medium text-gray-800">-</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-600">Difficulty:</span>
                                <span id="game-difficulty" class="font-medium text-gray-800">-</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-600">Controls:</span>
                                <span id="game-controls" class="font-medium text-gray-800">-</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-600">Players:</span>
                                <span id="game-players" class="font-medium text-gray-800">-</span>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-gray-600">Age Rating:</span>
                                <span id="game-age-rating" class="font-medium text-gray-800">-</span>
                            </li>
                        </ul>

                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-2">Developer</h4>
                            <p id="game-developer" class="text-gray-600">-</p>
                            <p id="game-developer-url" class="text-blue-600 hover:underline"><a href="#" target="_blank" rel="noopener noreferrer">-</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">RelaxPlayLand</h3>
                    <p class="text-gray-400">Your ultimate destination for relaxing online games.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="/#games" class="text-gray-400 hover:text-white transition-colors">Games</a></li>
                        <li><a href="/#about" class="text-gray-400 hover:text-white transition-colors">About</a></li>
                        <li><a href="/submit-game.html" class="text-gray-400 hover:text-white transition-colors">Submit Game</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact</h4>
                    <p class="text-gray-400">Have suggestions or feedback?</p>
                    <p class="text-gray-400">We'd love to hear from you!</p>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-400">&copy; 2025 RelaxPlayLand. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get game ID and data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            const gameDataParam = urlParams.get('data');
            
            if (!gameId) {
                showError('No game ID provided');
                return;
            }
            
            // Try to load game data from URL parameter first
            if (gameDataParam) {
                try {
                    const gameData = JSON.parse(decodeURIComponent(gameDataParam));
                    console.log('Using game data from URL parameter');
                    populateGameData(gameData);
                } catch (error) {
                    console.error('Error parsing game data from URL:', error);
                    // Fall back to API request
                    fetchGameDataWithRetry(gameId, 3);
                }
            } else {
                // No game data in URL, try API request
                console.log('No game data in URL, trying API request');
                fetchGameDataWithRetry(gameId, 3);
            }
            
            // Set up iframe error handling
            const gameIframe = document.getElementById('game-iframe');
            const gameFallback = document.getElementById('game-fallback');
            const reloadButton = document.getElementById('reload-game');
            const newWindowLink = document.getElementById('new-window-link');
            
            // Check if iframe loaded correctly
            gameIframe.addEventListener('load', function() {
                try {
                    // Just trying to access contentWindow can throw error if blocked
                    const iframeContent = gameIframe.contentWindow;
                    console.log('Game loaded successfully');
                } catch (error) {
                    console.error('Game iframe access error:', error);
                    showFallback();
                }
            });
            
            // Handle iframe errors
            gameIframe.addEventListener('error', function() {
                console.error('Game iframe failed to load');
                showFallback();
            });
            
            // Reload button functionality
            reloadButton.addEventListener('click', function() {
                gameIframe.src = gameIframe.src;
                gameFallback.style.display = 'none';
                gameIframe.style.display = 'block';
            });
            
            // Function to show fallback content
            function showFallback() {
                gameIframe.style.display = 'none';
                gameFallback.style.display = 'block';
            }
            
            // Set a timeout to check if the game is loaded
            setTimeout(function() {
                try {
                    // If we can't access iframe content after timeout, show fallback
                    if (gameIframe.contentDocument === null) {
                        showFallback();
                    }
                } catch (e) {
                    showFallback();
                }
            }, 5000);
        });
        
        // Function to fetch game data with retry mechanism
        async function fetchGameDataWithRetry(gameId, maxRetries) {
            let retries = 0;
            
            while (retries < maxRetries) {
                try {
                    await fetchGameData(gameId);
                    return; // Success, exit the retry loop
                } catch (error) {
                    retries++;
                    console.log(`Attempt ${retries}/${maxRetries} failed. ${retries < maxRetries ? 'Retrying...' : 'Giving up.'}`);
                    
                    if (retries >= maxRetries) {
                        showError(`Failed to load game data after ${maxRetries} attempts`);
                        break;
                    }
                    
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, retries - 1)));
                }
            }
        }
        
        // Function to fetch game data from API
        async function fetchGameData(gameId) {
            try {
                // Determine if we're in local development or production
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const apiUrl = isLocalDev ? `/api/games/${gameId}` : `https://relaxplayland.online/api/games/${gameId}`;
                
                console.log(`Fetching game data from: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON response but got ${contentType}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load game data');
                }
                
                // Access the game data from the response
                populateGameData(data.game);
                return data; // Return the data for potential use by the caller
            } catch (error) {
                console.error('Error fetching game data:', error);
                // Let the retry mechanism handle the error
                throw error;
            }
        }
        
        // Function to populate the page with game data
        function populateGameData(game) {
            if (!game) {
                showError('Invalid game data received');
                return;
            }
            
            try {
                // Format game data for display
                const gameData = {
                    ...game,
                    // Add computed properties if they don't exist
                    gameUrl: game.iframe || game.gameUrl || `/public/games/${game.slug}/index.html`,
                    instructions: game.instructions || game.howToPlay || 'No instructions available.',
                    features: game.features || 'No features listed.'
                };
                
                // Update page title and meta tags
                document.title = `${gameData.name} | RelaxPlayLand`;
                document.querySelector('meta[name="description"]').setAttribute('content', gameData.description || '');
                document.querySelector('meta[property="og:title"]').setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                document.querySelector('meta[property="og:description"]').setAttribute('content', gameData.description || '');
                document.querySelector('meta[name="twitter:title"]').setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                document.querySelector('meta[name="twitter:description"]').setAttribute('content', gameData.description || '');
                
                // Update game content
                document.getElementById('game-title').textContent = gameData.name;
                document.getElementById('game-description').textContent = gameData.description || 'No description available.';
                document.getElementById('game-instructions').textContent = gameData.instructions;
                document.getElementById('game-features').textContent = gameData.features;
                
                // Update game details
                document.getElementById('game-category').textContent = gameData.category || '-';
                document.getElementById('game-difficulty').textContent = gameData.difficulty || '-';
                document.getElementById('game-controls').textContent = gameData.controls || '-';
                document.getElementById('game-players').textContent = gameData.players || '-';
                document.getElementById('game-age-rating').textContent = gameData.ageRating || '-';
                
                // Update developer info
                if (gameData.developer) {
                    document.getElementById('game-developer').textContent = gameData.developer.name || '-';
                    const developerUrlElement = document.getElementById('game-developer-url').querySelector('a');
                    developerUrlElement.textContent = gameData.developer.website || gameData.developer.url || '-';
                    developerUrlElement.href = gameData.developer.website || gameData.developer.url || '#';
                }
                
                // Set iframe source - use iframe URL directly if available, or fallback to gameUrl
                const gameIframe = document.getElementById('game-iframe');
                gameIframe.src = gameData.iframe || gameData.gameUrl;
                gameIframe.title = gameData.name;
                
                // Set new window link
                const newWindowLink = document.getElementById('new-window-link');
                newWindowLink.href = gameData.iframe || gameData.gameUrl;
                
                // Add category and difficulty badges
                const badgesContainer = document.getElementById('game-badges');
                badgesContainer.innerHTML = '';
                
                if (gameData.category) {
                    const categoryBadge = document.createElement('span');
                    categoryBadge.className = 'badge bg-blue-100 text-blue-800';
                    categoryBadge.textContent = gameData.category;
                    badgesContainer.appendChild(categoryBadge);
                }
                
                if (gameData.difficulty) {
                    const difficultyBadge = document.createElement('span');
                    difficultyBadge.className = `badge badge-difficulty-${gameData.difficulty.toLowerCase()}`;
                    difficultyBadge.textContent = gameData.difficulty;
                    badgesContainer.appendChild(difficultyBadge);
                }
                
                // Hide loading state and show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error populating game data:', error);
                showError('Error displaying game content');
            }
        }
        
        // Function to show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorElement = document.getElementById('error-message');
            
            // Add more detailed error message
            const errorTitle = errorElement.querySelector('h2');
            const errorText = errorElement.querySelector('p');
            
            if (errorTitle && errorText) {
                errorTitle.textContent = 'Game Not Found';
                errorText.textContent = message || 'Sorry, we couldn\'t find the game you\'re looking for.';
            }
            
            // Add a button to try alternative loading method
            const returnLink = errorElement.querySelector('a');
            if (returnLink) {
                const gameId = new URLSearchParams(window.location.search).get('id');
                const fallbackButton = document.createElement('a');
                fallbackButton.className = 'mt-4 ml-4 inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors';
                fallbackButton.textContent = 'Try Alternative Loading';
                fallbackButton.href = `/games/${gameId}.html`;
                returnLink.parentNode.appendChild(fallbackButton);
            }
            
            errorElement.style.display = 'block';
            console.error(message);
            
            // Add debugging info
            const gameId = new URLSearchParams(window.location.search).get('id');
            console.log(`Attempted to load game with ID: ${gameId}`);
        }
    </script>
</body>
</html> 