<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game | RelaxPlayLand</title>
    <meta name="description" content="Play relaxing games on RelaxPlayLand">
    <meta name="keywords" content="games, relaxing, online games">
    <meta name="author" content="RelaxPlayLand">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://relaxplayland.online/game-template.html">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4053948353567712"
     crossorigin="anonymous"></script>
    
    <!-- Open Graph Meta Tags (will be updated dynamically) -->
    <meta property="og:title" content="Game | RelaxPlayLand">
    <meta property="og:description" content="Play relaxing games on RelaxPlayLand">
    <meta property="og:url" content="https://relaxplayland.online/game-template.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="RelaxPlayLand">
    
    <!-- Twitter Card Meta Tags (will be updated dynamically) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Game | RelaxPlayLand">
    <meta name="twitter:description" content="Play relaxing games on RelaxPlayLand">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">
    
    <style>
        .game-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        @media (max-width: 768px) {
            .game-iframe {
                height: 400px;
            }
        }
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .game-fallback {
            display: none;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            border-radius: 8px;
        }
        .game-fallback h3 {
            color: #4B5563;
            margin-bottom: 10px;
        }
        .game-fallback p {
            color: #6B7280;
            margin-bottom: 15px;
        }
        .game-fallback a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #3B82F6;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: #FEE2E2;
            border-radius: 8px;
            color: #B91C1C;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">RelaxPlayLand</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</a>
                        <a href="/#games" class="text-blue-600 hover:text-blue-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Games</a>
                        <a href="/#about" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">About</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading state -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading game data...</p>
        </div>
        
        <!-- Error message -->
        <div id="error-message" class="error-message">
            <h2 class="text-xl font-bold mb-2">Game Not Found</h2>
            <p>Sorry, we couldn't find the game you're looking for.</p>
            <a href="/" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                Return to Home
            </a>
        </div>
        
        <!-- Game content (initially hidden) -->
        <div id="game-content" class="bg-white rounded-lg shadow-lg overflow-hidden" style="display: none;">
            <!-- Game Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 id="game-title" class="text-3xl font-bold text-gray-800">Game Title</h1>
                        <div id="game-badges" class="flex flex-wrap items-center mt-2 space-x-2">
                            <!-- Badges will be inserted here -->
                        </div>
                    </div>
                    <a href="/" class="mt-4 md:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Games
                    </a>
                </div>
            </div>

            <!-- Game Content -->
            <div class="p-6">
                <!-- Game Iframe -->
                <div class="bg-gray-800 rounded-lg overflow-hidden mb-8">
                    <iframe id="game-iframe" src="" class="game-iframe" title="Game" allowfullscreen frameborder="0"></iframe>
                    <!-- Direct iframe container for fallback -->
                    <div id="direct-iframe-container" style="display: none; width: 100%; height: 600px;"></div>
                    <!-- Fallback content if game fails to load -->
                    <div id="game-fallback" class="game-fallback">
                        <h3>Game Loading Issue</h3>
                        <p>Sorry, the game couldn't be loaded properly. Please try one of these options:</p>
                        <div class="space-y-3">
                            <a id="new-window-link" href="#" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Play in New Window</a>
                            <p>or</p>
                            <button id="reload-game" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Reload Game</button>
                        </div>
                    </div>
                </div>

                <!-- Game Info -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">About This Game</h2>
                        <p id="game-description" class="text-gray-600 mb-6">Game description will be loaded here.</p>
                        
                        <h3 class="text-xl font-bold mb-3 text-gray-800">How to Play</h3>
                        <p id="game-instructions" class="text-gray-600 mb-6">Game instructions will be loaded here.</p>
                        
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Game Details</h3>
                        <ul class="space-y-3">
                            <li class="flex justify-between">
                                <span class="text-gray-600">Category:</span>
                                <span id="game-category" class="font-medium text-gray-800">-</span>
                            </li>
                        </ul>

                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-2">Developer</h4>
                            <p id="game-developer" class="text-gray-600">-</p>
                            <p id="game-developer-url" class="text-blue-600 hover:underline"><a href="#" target="_blank" rel="noopener noreferrer">-</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">RelaxPlayLand</h3>
                    <p class="text-gray-400">Your ultimate destination for relaxing online games.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="/#games" class="text-gray-400 hover:text-white transition-colors">Games</a></li>
                        <li><a href="/#about" class="text-gray-400 hover:text-white transition-colors">About</a></li>
                        <li><a href="/submit-game.html" class="text-gray-400 hover:text-white transition-colors">Submit Game</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact</h4>
                    <p class="text-gray-400">Have suggestions or feedback?</p>
                    <p class="text-gray-400">We'd love to hear from you!</p>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-400">&copy; 2025 RelaxPlayLand. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
                            // Get game ID and data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            const gameDataParam = urlParams.get('data');
            
            console.log('Game ID:', gameId);
            console.log('Game data param length:', gameDataParam ? gameDataParam.length : 0);
            
            if (!gameId) {
                showError('No game ID provided');
                return;
            }
            
            // Preload common game hosting domains to improve loading success
            preloadDomains([
                'www.crazygames.com', 
                'html5.gamemonetize.com', 
                'games.construct.net',
                'html5.gamedistribution.com',
                'cdn.gamemonetize.com',
                'play.gamemonetize.com',
                'play.famobi.com',
                'play.gamepix.com'
            ]);
            
            // Try to load game data from URL parameter first
            if (gameDataParam) {
                try {
                    // Attempt to extract game data using multiple approaches
                    let gameData = null;
                    
                    // Approach 1: Try to directly extract the iframe HTML if present
                    console.log('Attempting to extract iframe directly from URL parameter');
                    const iframeMatch = gameDataParam.match(/iframe":\s*"([^"]+)"/);
                    const nameMatch = gameDataParam.match(/name":\s*"([^"]+)"/);
                    const imageMatch = gameDataParam.match(/image":\s*"([^"]+)"/);
                    const descriptionMatch = gameDataParam.match(/description":\s*"([^"]+)"/);
                    const categoryMatch = gameDataParam.match(/category":\s*"([^"]+)"/);
                    const howToPlayMatch = gameDataParam.match(/howToPlay":\s*"([^"]+)"/);
                    
                    if (iframeMatch && nameMatch) {
                        console.log('Successfully extracted iframe and name from URL parameter');
                        
                        // Create a simplified game object with the extracted data
                        gameData = {
                            id: gameId,
                            name: nameMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"'),
                            iframe: iframeMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"'),
                            image: imageMatch ? imageMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"') : '',
                            description: descriptionMatch ? descriptionMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"').replace(/\\r\\n/g, '<br>') : '',
                            category: categoryMatch ? categoryMatch[1] : 'Uncategorized',
                            howToPlay: howToPlayMatch ? howToPlayMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"').replace(/\\r\\n/g, '<br>') : ''
                        };
                    } else {
                        // Approach 2: Try standard decoding
                        try {
                            console.log('Attempting standard decoding of game data parameter');
                            // Replace problematic sequences before decoding
                            const cleanedParam = gameDataParam
                                .replace(/%5Cr%5Cn/g, ' ') // Replace \r\n with space
                                .replace(/%5C%22/g, '%22'); // Replace \" with "
                                
                            gameData = JSON.parse(decodeURIComponent(cleanedParam));
                            console.log('Standard decoding successful');
                        } catch (decodeError) {
                            console.log('Standard decoding failed with error:', decodeError.message);
                            
                            // Approach 3: Try manual JSON extraction
                            try {
                                console.log('Trying manual JSON extraction');
                                // Convert escaped JSON to proper JSON
                                const jsonString = gameDataParam
                                    .replace(/%7B/g, '{')
                                    .replace(/%7D/g, '}')
                                    .replace(/%22/g, '"')
                                    .replace(/%20/g, ' ')
                                    .replace(/%3A/g, ':')
                                    .replace(/%2C/g, ',')
                                    .replace(/%5B/g, '[')
                                    .replace(/%5D/g, ']')
                                    .replace(/%5C/g, '\\')
                                    .replace(/%25/g, '%');
                                    
                                gameData = JSON.parse(jsonString);
                                console.log('Manual JSON extraction successful');
                            } catch (jsonError) {
                                console.log('Manual JSON extraction failed:', jsonError.message);
                                throw new Error('Could not parse game data parameter');
                            }
                        }
                    }
                    
                    // Process the game data
                    if (gameData) {
                        // Format game data for display
                        populateGameData(gameData);
                        return;
                    }
                } catch (error) {
                    console.error('Error parsing game data from URL:', error);
                    // Continue to API fallback
                }
            }
            
            // No game data in URL, try API request
            console.log('No game data in URL, trying API request');
            fetchGameDataWithRetry(gameId, 3);
            
            // Set up iframe error handling
            const gameFallback = document.getElementById('game-fallback');
            const reloadButton = document.getElementById('reload-game');
            const newWindowLink = document.getElementById('new-window-link');
            const directIframeContainer = document.getElementById('direct-iframe-container');
            
            // Set up initial iframe event listeners
            setupIframeEventListeners(document.getElementById('game-iframe'));
            
            // Reload button functionality
            reloadButton.addEventListener('click', function() {
                // Show loading state on button
                const originalText = reloadButton.textContent;
                reloadButton.textContent = "Loading...";
                reloadButton.disabled = true;
                
                const directIframeContainer = document.getElementById('direct-iframe-container');
                
                // Check which display mode we're in
                if (directIframeContainer.style.display === 'block') {
                    // We're using the direct container, reload that
                    const iframeElement = directIframeContainer.querySelector('iframe');
                    if (iframeElement) {
                        const currentSrc = iframeElement.src;
                        iframeElement.src = '';
                        setTimeout(() => {
                            iframeElement.src = currentSrc;
                            
                            // Reset button state after a delay
                            setTimeout(() => {
                                reloadButton.textContent = originalText;
                                reloadButton.disabled = false;
                            }, 1000);
                        }, 200);
                    } else {
                        // No iframe found, try reloading the container
                        const currentHTML = directIframeContainer.innerHTML;
                        directIframeContainer.innerHTML = '';
                        setTimeout(() => {
                            directIframeContainer.innerHTML = currentHTML;
                            
                            // Reset button state after a delay
                            setTimeout(() => {
                                reloadButton.textContent = originalText;
                                reloadButton.disabled = false;
                            }, 1000);
                        }, 200);
                    }
                } else {
                    // Using the regular iframe
                    const gameIframe = document.getElementById('game-iframe');
                    if (gameIframe) {
                        const currentSrc = gameIframe.src;
                        
                        // For CrazyGames, try a special reload approach
                        if (currentSrc.includes('crazygames.com')) {
                            console.log('Reloading CrazyGames iframe with special approach');
                            
                            // Get the game slug
                            const slugMatch = currentSrc.match(/\/embed\/([^/?#]+)/);
                            if (slugMatch && slugMatch[1]) {
                                const gameSlug = slugMatch[1];
                                
                                // Create a new iframe to replace the old one
                                const newIframe = document.createElement('iframe');
                                newIframe.id = 'game-iframe';
                                newIframe.className = 'game-iframe';
                                newIframe.src = `https://www.crazygames.com/embed/${gameSlug}`;
                                newIframe.title = gameIframe.title || 'Game';
                                newIframe.allow = 'fullscreen; autoplay; gamepad *;';
                                newIframe.allowFullscreen = true;
                                newIframe.frameBorder = '0';
                                
                                // Replace the old iframe
                                gameIframe.parentNode.replaceChild(newIframe, gameIframe);
                                
                                // Set up event listeners for the new iframe
                                setupIframeEventListeners(newIframe);
                                
                                // Reset button state after a delay
                                setTimeout(() => {
                                    reloadButton.textContent = originalText;
                                    reloadButton.disabled = false;
                                }, 1000);
                            } else {
                                // Standard reload approach
                                gameIframe.src = '';
                                setTimeout(() => {
                                    gameIframe.src = currentSrc;
                                    
                                    // Reset button state after a delay
                                    setTimeout(() => {
                                        reloadButton.textContent = originalText;
                                        reloadButton.disabled = false;
                                    }, 1000);
                                }, 200);
                            }
                        } else {
                            // Standard reload approach
                            gameIframe.src = '';
                            setTimeout(() => {
                                gameIframe.src = currentSrc;
                                
                                // Reset button state after a delay
                                setTimeout(() => {
                                    reloadButton.textContent = originalText;
                                    reloadButton.disabled = false;
                                }, 1000);
                            }, 200);
                        }
                    } else {
                        // No iframe found
                        reloadButton.textContent = originalText;
                        reloadButton.disabled = false;
                    }
                }
                
                gameFallback.style.display = 'none';
                if (directIframeContainer.style.display === 'block') {
                    document.getElementById('game-iframe').style.display = 'none';
                    directIframeContainer.style.display = 'block';
                } else {
                    document.getElementById('game-iframe').style.display = 'block';
                }
            });
            
            // Function to show fallback content
            function showFallback() {
                const gameIframe = document.getElementById('game-iframe');
                if (gameIframe) {
                    gameIframe.style.display = 'none';
                }
                directIframeContainer.style.display = 'none';
                gameFallback.style.display = 'block';
            }
            
            // Set a timeout to check if the game is loaded
            setTimeout(function() {
                const gameIframe = document.getElementById('game-iframe');
                if (!gameIframe) return;
                
                try {
                    // If we can't access iframe content after timeout, check status
                    if (gameIframe.contentDocument === null) {
                        console.log('Timeout reached, checking iframe status');
                        
                        // For CrazyGames, don't show fallback immediately as they can take longer to load
                        if (gameIframe.src && gameIframe.src.includes('crazygames.com')) {
                            console.log('CrazyGames iframe detected, giving extra time to load');
                            // Give extra time for CrazyGames to load
                            setTimeout(() => {
                                // Only show fallback if the game is still not visible
                                if (gameIframe.offsetHeight === 0 || gameIframe.offsetWidth === 0) {
                                    showFallback();
                                }
                            }, 5000); // Extra 5 seconds
                        } else {
                            // For non-CrazyGames, check if iframe is empty
                            if (gameIframe.src === '' || gameIframe.src === 'about:blank') {
                                showFallback();
                            }
                        }
                    }
                } catch (e) {
                    // This is expected for cross-origin iframes
                    console.log('Cross-origin iframe detected (normal behavior)');
                }
            }, 5000);
            
            // Also check the direct iframe container if it's being used
            setTimeout(function() {
                if (directIframeContainer.style.display === 'block') {
                    const directIframe = directIframeContainer.querySelector('iframe');
                    if (!directIframe || directIframe.src === '' || directIframe.src === 'about:blank') {
                        console.error('Direct iframe container has issues');
                        
                        // Try auto-reload once for direct iframe container
                        if (!directIframeContainer.dataset.autoReloaded) {
                            console.log('Auto-reloading direct iframe container...');
                            directIframeContainer.dataset.autoReloaded = "true";
                            
                            // Store current HTML
                            const currentHTML = directIframeContainer.innerHTML;
                            
                            // Clear and reset HTML after a short delay
                            directIframeContainer.innerHTML = "";
                            setTimeout(() => {
                                directIframeContainer.innerHTML = currentHTML;
                            }, 200);
                        } else {
                            showFallback();
                        }
                    }
                }
            }, 5000);
            
            // Function to preload common game hosting domains
            function preloadDomains(domains) {
                domains.forEach(domain => {
                    // Create a link preconnect element
                    const link = document.createElement('link');
                    link.rel = 'preconnect';
                    link.href = `https://${domain}`;
                    document.head.appendChild(link);
                    
                    // Also add DNS-prefetch as fallback
                    const dnsPrefetch = document.createElement('link');
                    dnsPrefetch.rel = 'dns-prefetch';
                    dnsPrefetch.href = `https://${domain}`;
                    document.head.appendChild(dnsPrefetch);
                    
                    console.log(`Preloaded domain: ${domain}`);
                });
            }
        });
        
        // Function to set up iframe event listeners
        function setupIframeEventListeners(iframe) {
            if (!iframe) return;
            
            // Add loading event handler
            iframe.addEventListener('load', function() {
                console.log('Game iframe loaded successfully');
                // You could trigger analytics events here
            });
            
            // Add error event handler
            iframe.addEventListener('error', function(e) {
                console.error('Error loading game iframe:', e);
                showError('Failed to load game. Please try refreshing the page.');
            });
            
            // Set security attributes
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms');
            iframe.setAttribute('loading', 'lazy');
            
            // Set additional attributes for better user experience
            iframe.setAttribute('allow', 'fullscreen; autoplay; clipboard-write; encrypted-media; gamepad; accelerometer; gyroscope; picture-in-picture');
        }
        
        // Function to fetch game data with retry
        async function fetchGameDataWithRetry(gameId, maxRetries = 3, retryCount = 0) {
            try {
                const gameData = await fetchGameData(gameId);
                if (gameData) {
                    populateGameData(gameData);
                } else {
                    throw new Error('No game data returned');
                }
            } catch (error) {
                console.error(`Error fetching game data (attempt ${retryCount + 1}/${maxRetries}):`, error);
                
                if (retryCount < maxRetries - 1) {
                    // Exponential backoff for retries
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.log(`Retrying in ${delay}ms...`);
                    
                    setTimeout(() => {
                        fetchGameDataWithRetry(gameId, maxRetries, retryCount + 1);
                    }, delay);
                } else {
                    console.error('All retry attempts failed');
                    
                    // Last resort: try to extract from URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const gameDataParam = urlParams.get('data');
                    
                    if (gameDataParam) {
                        try {
                            // Try direct extraction of iframe from parameter
                            const iframeMatch = gameDataParam.match(/iframe":\s*"([^"]+)"/);
                            if (iframeMatch && iframeMatch[1]) {
                                console.log('Creating minimal game data from URL parameter');
                                
                                // Create minimal game data
                                const minimalGameData = {
                                    id: gameId,
                                    name: `Game ${gameId}`,
                                    iframe: iframeMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"'),
                                    description: 'Game description not available.',
                                    howToPlay: 'Game instructions not available.'
                                };
                                
                                populateGameData(minimalGameData);
                                return;
                            }
                        } catch (extractError) {
                            console.error('Failed to extract iframe from URL parameter:', extractError);
                        }
                    }
                    
                    // If all else fails, show error
                    showError('Failed to load game data. Please try refreshing the page.');
                }
            }
        }
        
        // Function to fetch game data from API
        async function fetchGameData(gameId) {
            try {
                // Determine if we're in local development or production
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const apiUrl = isLocalDev ? `/api/games/${gameId}` : `https://relaxplayland.online/api/games/${gameId}`;
                
                console.log(`Fetching game data from: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'same-origin'
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.log(`API returned non-JSON response: ${contentType}`);
                    
                    // Try to extract game data from URL parameter as fallback
                    const urlParams = new URLSearchParams(window.location.search);
                    const gameDataParam = urlParams.get('data');
                    
                    if (gameDataParam) {
                        try {
                            // Try to parse the URL parameter data
                            const gameData = extractGameDataFromParam(gameDataParam);
                            if (gameData) {
                                return gameData;
                            }
                        } catch (paramError) {
                            console.log('Failed to parse URL parameter data as fallback:', paramError);
                        }
                    }
                    
                    throw new Error(`Expected JSON response but got ${contentType}`);
                }
                
                const data = await response.json();
                
                // Validate response data
                if (!data || !data.name) {
                    console.error('Invalid game data received from API:', data);
                    throw new Error('Invalid game data received from API');
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching game data:', error);
                throw error;
            }
        }
        
        // Helper function to extract game data from URL parameter
        function extractGameDataFromParam(param) {
            // Try direct extraction using regex
            const iframeMatch = param.match(/iframe":\s*"([^"]+)"/);
            const nameMatch = param.match(/name":\s*"([^"]+)"/);
            const imageMatch = param.match(/image":\s*"([^"]+)"/);
            const descriptionMatch = param.match(/description":\s*"([^"]+)"/);
            const categoryMatch = param.match(/category":\s*"([^"]+)"/);
            const howToPlayMatch = param.match(/howToPlay":\s*"([^"]+)"/);
            
            if (iframeMatch && nameMatch) {
                // Create a simplified game object with the extracted data
                return {
                    id: new URLSearchParams(window.location.search).get('id'),
                    name: nameMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"'),
                    iframe: iframeMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"'),
                    image: imageMatch ? imageMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"') : '',
                    description: descriptionMatch ? descriptionMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"').replace(/\\r\\n/g, '<br>') : '',
                    category: categoryMatch ? categoryMatch[1] : 'Uncategorized',
                    howToPlay: howToPlayMatch ? howToPlayMatch[1].replace(/\\"/g, '"').replace(/\\\\"/g, '\\"').replace(/\\r\\n/g, '<br>') : ''
                };
            }
            
            // Try various decoding approaches
            try {
                // Replace problematic sequences before decoding
                const cleanedParam = param
                    .replace(/%5Cr%5Cn/g, ' ') // Replace \r\n with space
                    .replace(/%5C%22/g, '%22'); // Replace \" with "
                    
                return JSON.parse(decodeURIComponent(cleanedParam));
            } catch (decodeError) {
                // Try manual JSON extraction
                const jsonString = param
                    .replace(/%7B/g, '{')
                    .replace(/%7D/g, '}')
                    .replace(/%22/g, '"')
                    .replace(/%20/g, ' ')
                    .replace(/%3A/g, ':')
                    .replace(/%2C/g, ',')
                    .replace(/%5B/g, '[')
                    .replace(/%5D/g, ']')
                    .replace(/%5C/g, '\\')
                    .replace(/%25/g, '%');
                    
                return JSON.parse(jsonString);
            }
        }
        
        // Function to populate the page with game data
        function populateGameData(game) {
            if (!game) {
                showError('Invalid game data received');
                return;
            }
            
            try {
                // Format game data for display
                const gameData = {
                    ...game,
                    // Add computed properties if they don't exist
                    gameUrl: game.iframe || game.gameUrl || `/public/games/${game.slug}/index.html`,
                    instructions: game.instructions || game.howToPlay || 'No instructions available.'
                };
                
                // Update page title and meta tags
                document.title = `${gameData.name} | RelaxPlayLand`;
                
                // Safely update meta tags with null checks
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription) {
                    metaDescription.setAttribute('content', gameData.description || '');
                }
                
                // Update Open Graph and Twitter meta tags with null checks
                const ogTitle = document.querySelector('meta[property="og:title"]');
                if (ogTitle) {
                    ogTitle.setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                }
                
                const ogDescription = document.querySelector('meta[property="og:description"]');
                if (ogDescription) {
                    ogDescription.setAttribute('content', gameData.description || '');
                }
                
                const twitterTitle = document.querySelector('meta[name="twitter:title"]');
                if (twitterTitle) {
                    twitterTitle.setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                }
                
                const twitterDescription = document.querySelector('meta[name="twitter:description"]');
                if (twitterDescription) {
                    twitterDescription.setAttribute('content', gameData.description || '');
                }
                
                if (gameData.image) {
                    const ogImage = document.querySelector('meta[property="og:image"]');
                    if (ogImage) {
                        ogImage.setAttribute('content', gameData.image);
                    }
                    
                    const twitterImage = document.querySelector('meta[name="twitter:image"]');
                    if (twitterImage) {
                        twitterImage.setAttribute('content', gameData.image);
                    }
                }
                
                // Update game details in the page with null checks
                const gameTitleElement = document.getElementById('game-title');
                if (gameTitleElement) {
                    gameTitleElement.textContent = gameData.name;
                }
                
                const gameCategoryElement = document.getElementById('game-category');
                if (gameCategoryElement) {
                    gameCategoryElement.textContent = gameData.category || 'Uncategorized';
                }
                
                // Format description and instructions with proper line breaks
                const descriptionElement = document.getElementById('game-description');
                if (descriptionElement) {
                    descriptionElement.innerHTML = gameData.description ? gameData.description.replace(/\\r\\n/g, '<br>').replace(/\r\n/g, '<br>') : '';
                }
                
                const instructionsElement = document.getElementById('game-instructions');
                if (instructionsElement) {
                    instructionsElement.innerHTML = gameData.instructions ? gameData.instructions.replace(/\\r\\n/g, '<br>').replace(/\r\n/g, '<br>') : '';
                }
                
                // Update developer info if available
                const developerElement = document.getElementById('game-developer');
                const developerUrlElement = document.getElementById('game-developer-url');
                
                if (developerElement && gameData.developer) {
                    developerElement.textContent = gameData.developer.name || '-';
                    
                    if (developerUrlElement && gameData.developer.website) {
                        const link = developerUrlElement.querySelector('a');
                        if (link) {
                            link.href = gameData.developer.website;
                            link.textContent = gameData.developer.website;
                            link.style.display = 'inline';
                        }
                    } else if (developerUrlElement) {
                        developerUrlElement.style.display = 'none';
                    }
                }
                
                // Handle game badges
                const badgesContainer = document.getElementById('game-badges');
                if (badgesContainer && gameData.tags && gameData.tags.length > 0) {
                    badgesContainer.innerHTML = '';
                    
                    gameData.tags.forEach(tag => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-blue-100 text-blue-800';
                        badge.textContent = tag;
                        badgesContainer.appendChild(badge);
                    });
                }
                
                // Handle game iframe
                const gameIframe = document.getElementById('game-iframe');
                const directIframeContainer = document.getElementById('direct-iframe-container');
                
                if (gameIframe && directIframeContainer) {
                    // Check if we have an iframe HTML string
                    if (gameData.iframe && typeof gameData.iframe === 'string') {
                        console.log('Using provided iframe HTML');
                        
                        try {
                            // Method 1: Try direct HTML insertion (like admin panel)
                            // Create a safe version of the iframe HTML
                            const cleanIframe = gameData.iframe
                                .replace(/\\"/g, '"')  // Replace escaped quotes
                                .replace(/\\\\/g, '\\'); // Replace double backslashes
                                
                            // Insert the iframe HTML into the direct container
                            directIframeContainer.innerHTML = cleanIframe;
                            
                            // Check if iframe was inserted correctly
                            if (directIframeContainer.querySelector('iframe')) {
                                console.log('Iframe inserted successfully using direct HTML');
                                
                                // Hide the standard iframe and show the direct container
                                gameIframe.style.display = 'none';
                                directIframeContainer.style.display = 'block';
                                
                                // Set up iframe event listeners
                                setupIframeEventListeners(directIframeContainer.querySelector('iframe'));
                            } else {
                                throw new Error('Failed to insert iframe using direct HTML');
                            }
                        } catch (directInsertError) {
                            console.error('Error inserting iframe directly:', directInsertError);
                            
                            try {
                                // Method 2: Extract src, width, height from iframe string
                                console.log('Trying to extract iframe attributes');
                                const srcMatch = gameData.iframe.match(/src=["']([^"']+)["']/i);
                                const widthMatch = gameData.iframe.match(/width=["']([^"']+)["']/i);
                                const heightMatch = gameData.iframe.match(/height=["']([^"']+)["']/i);
                                
                                if (srcMatch && srcMatch[1]) {
                                    // Use the standard iframe
                                    gameIframe.src = srcMatch[1].replace(/\\"/g, '"');
                                    if (widthMatch && widthMatch[1]) gameIframe.width = widthMatch[1];
                                    if (heightMatch && heightMatch[1]) gameIframe.height = heightMatch[1];
                                    
                                    // Show the standard iframe
                                    gameIframe.style.display = 'block';
                                    directIframeContainer.style.display = 'none';
                                    
                                    console.log('Iframe created using extracted attributes');
                                } else {
                                    throw new Error('Could not extract iframe src');
                                }
                            } catch (extractError) {
                                console.error('Error creating iframe from attributes:', extractError);
                                showError('Failed to load game iframe. Please try refreshing the page.');
                            }
                        }
                    } else if (gameData.gameUrl) {
                        // Use gameUrl with the standard iframe
                        console.log('Creating iframe from gameUrl:', gameData.gameUrl);
                        gameIframe.src = gameData.gameUrl;
                        gameIframe.style.display = 'block';
                        directIframeContainer.style.display = 'none';
                    } else {
                        showError('No game URL or iframe provided');
                    }
                }
                
                // Set up "Play in New Window" link
                const newWindowLink = document.getElementById('new-window-link');
                if (newWindowLink) {
                    const gameUrl = gameData.gameUrl || (gameData.iframe ? gameData.iframe.match(/src=["']([^"']+)["']/i)?.[1] : null);
                    if (gameUrl) {
                        newWindowLink.href = gameUrl.replace(/\\"/g, '"');
                    } else {
                        newWindowLink.style.display = 'none';
                    }
                }
                
                // Hide loading indicator and show game content
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                const gameContentElement = document.getElementById('game-content');
                if (gameContentElement) {
                    gameContentElement.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error populating game data:', error);
                showError('Failed to display game data. Please try refreshing the page.');
            }
        }
        
        // Function to show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorElement = document.getElementById('error-message');
            
            // Add more detailed error message
            const errorTitle = errorElement.querySelector('h2');
            const errorText = errorElement.querySelector('p');
            
            if (errorTitle && errorText) {
                errorTitle.textContent = 'Game Not Found';
                errorText.textContent = message || 'Sorry, we couldn\'t find the game you\'re looking for.';
            }
            
            // Add a button to try alternative loading method
            const returnLink = errorElement.querySelector('a');
            if (returnLink) {
                const gameId = new URLSearchParams(window.location.search).get('id');
                const fallbackButton = document.createElement('a');
                fallbackButton.className = 'mt-4 ml-4 inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors';
                fallbackButton.textContent = 'Try Alternative Loading';
                fallbackButton.href = `/games/${gameId}.html`;
                returnLink.parentNode.appendChild(fallbackButton);
            }
            
            errorElement.style.display = 'block';
            console.error(message);
            
            // Add debugging info
            const gameId = new URLSearchParams(window.location.search).get('id');
            console.log(`Attempted to load game with ID: ${gameId}`);
        }
    </script>
</body>
</html> 