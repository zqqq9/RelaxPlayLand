<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game | RelaxPlayLand</title>
    <meta name="description" content="Play relaxing games on RelaxPlayLand">
    <meta name="keywords" content="games, relaxing, online games">
    <meta name="author" content="RelaxPlayLand">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://relaxplayland.online/game-template.html">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4053948353567712"
     crossorigin="anonymous"></script>
    
    <!-- Open Graph Meta Tags (will be updated dynamically) -->
    <meta property="og:title" content="Game | RelaxPlayLand">
    <meta property="og:description" content="Play relaxing games on RelaxPlayLand">
    <meta property="og:url" content="https://relaxplayland.online/game-template.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="RelaxPlayLand">
    
    <!-- Twitter Card Meta Tags (will be updated dynamically) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Game | RelaxPlayLand">
    <meta name="twitter:description" content="Play relaxing games on RelaxPlayLand">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <link href="/dist/output.css" rel="stylesheet">
    
    <style>
        .game-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        @media (max-width: 768px) {
            .game-iframe {
                height: 400px;
            }
        }
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .game-fallback {
            display: none;
            padding: 20px;
            text-align: center;
            background-color: #f9fafb;
            border-radius: 8px;
        }
        .game-fallback h3 {
            color: #4B5563;
            margin-bottom: 10px;
        }
        .game-fallback p {
            color: #6B7280;
            margin-bottom: 15px;
        }
        .game-fallback a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #3B82F6;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
        }
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: #FEE2E2;
            border-radius: 8px;
            color: #B91C1C;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">RelaxPlayLand</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</a>
                        <a href="/#games" class="text-blue-600 hover:text-blue-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Games</a>
                        <a href="/#about" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">About</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading state -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading game data...</p>
        </div>
        
        <!-- Error message -->
        <div id="error-message" class="error-message">
            <h2 class="text-xl font-bold mb-2">Game Not Found</h2>
            <p>Sorry, we couldn't find the game you're looking for.</p>
            <a href="/" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                Return to Home
            </a>
        </div>
        
        <!-- Game content (initially hidden) -->
        <div id="game-content" class="bg-white rounded-lg shadow-lg overflow-hidden" style="display: none;">
            <!-- Game Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 id="game-title" class="text-3xl font-bold text-gray-800">Game Title</h1>
                        <div id="game-badges" class="flex flex-wrap items-center mt-2 space-x-2">
                            <!-- Badges will be inserted here -->
                        </div>
                    </div>
                    <a href="/" class="mt-4 md:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Games
                    </a>
                </div>
            </div>

            <!-- Game Content -->
            <div class="p-6">
                <!-- Game Iframe -->
                <div class="bg-gray-800 rounded-lg overflow-hidden mb-8">
                    <iframe id="game-iframe" src="" class="game-iframe" title="Game" allowfullscreen frameborder="0"></iframe>
                    <!-- Direct iframe container for fallback -->
                    <div id="direct-iframe-container" style="display: none; width: 100%; height: 600px;"></div>
                    <!-- Fallback content if game fails to load -->
                    <div id="game-fallback" class="game-fallback">
                        <h3>Game Loading Issue</h3>
                        <p>Sorry, the game couldn't be loaded properly. Please try one of these options:</p>
                        <div class="space-y-3">
                            <a id="new-window-link" href="#" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Play in New Window</a>
                            <p>or</p>
                            <button id="reload-game" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Reload Game</button>
                        </div>
                    </div>
                </div>

                <!-- Game Info -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">About This Game</h2>
                        <p id="game-description" class="text-gray-600 mb-6">Game description will be loaded here.</p>
                        
                        <h3 class="text-xl font-bold mb-3 text-gray-800">How to Play</h3>
                        <p id="game-instructions" class="text-gray-600 mb-6">Game instructions will be loaded here.</p>
                        
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Game Details</h3>
                        <ul class="space-y-3">
                            <li class="flex justify-between">
                                <span class="text-gray-600">Category:</span>
                                <span id="game-category" class="font-medium text-gray-800">-</span>
                            </li>
                        </ul>

                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-2">Developer</h4>
                            <p id="game-developer" class="text-gray-600">-</p>
                            <p id="game-developer-url" class="text-blue-600 hover:underline"><a href="#" target="_blank" rel="noopener noreferrer">-</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">RelaxPlayLand</h3>
                    <p class="text-gray-400">Your ultimate destination for relaxing online games.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="/#games" class="text-gray-400 hover:text-white transition-colors">Games</a></li>
                        <li><a href="/#about" class="text-gray-400 hover:text-white transition-colors">About</a></li>
                        <li><a href="/submit-game.html" class="text-gray-400 hover:text-white transition-colors">Submit Game</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact</h4>
                    <p class="text-gray-400">Have suggestions or feedback?</p>
                    <p class="text-gray-400">We'd love to hear from you!</p>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-400">&copy; 2025 RelaxPlayLand. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
                            // Get game ID and data from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            const gameDataParam = urlParams.get('data');
            
            console.log('Game ID:', gameId);
            console.log('Game data param length:', gameDataParam ? gameDataParam.length : 0);
            
            if (!gameId) {
                showError('No game ID provided');
                return;
            }
            
            // Preload common game hosting domains to improve loading success
            preloadDomains([
                'www.crazygames.com', 
                'html5.gamemonetize.com', 
                'games.construct.net',
                'html5.gamedistribution.com',
                'cdn.gamemonetize.com',
                'play.gamemonetize.com',
                'play.famobi.com',
                'play.gamepix.com'
            ]);
            
            // Try to load game data from URL parameter first
            if (gameDataParam) {
                try {
                    // Safely decode the game data parameter
                    let gameData;
                    try {
                        // First try standard decoding
                        console.log('Attempting standard decoding of game data parameter');
                        gameData = JSON.parse(decodeURIComponent(gameDataParam));
                    } catch (decodeError) {
                        // If that fails, try a more careful approach to handle malformed URIs
                        console.log('Standard decoding failed with error:', decodeError.message);
                        console.log('Trying alternative decoding approach');
                        
                        // Log the problematic sequences
                        console.log('URL parameter contains \\r\\n sequences:', gameDataParam.includes('%5Cr%5Cn'));
                        console.log('URL parameter contains escaped backslashes:', gameDataParam.includes('%5C'));
                        
                        // Replace problematic escape sequences before decoding
                        const fixedParam = gameDataParam
                            .replace(/%5Cr%5Cn/g, '\\n')  // Replace \r\n with just \n
                            .replace(/%5C/g, '\\');       // Fix other escaped backslashes
                        
                        // Try decoding the fixed parameter
                        try {
                            gameData = JSON.parse(decodeURIComponent(fixedParam));
                            console.log('Alternative decoding successful');
                        } catch (secondError) {
                            console.error('Alternative decoding also failed:', secondError.message);
                            
                            // Last resort: try to extract the iframe directly
                            console.log('Attempting to extract iframe directly from parameter');
                            const iframeMatch = gameDataParam.match(/%22iframe%22%3A%22(.+?)%22%2C/);
                            if (iframeMatch && iframeMatch[1]) {
                                console.log('Found iframe data in parameter, creating minimal game data');
                                
                                // Create minimal game data with just the iframe
                                const iframeContent = decodeURIComponent(iframeMatch[1]);
                                gameData = {
                                    id: gameId,
                                    name: "Game " + gameId,
                                    iframe: iframeContent,
                                    description: "Game loaded with minimal data",
                                    howToPlay: "Controls depend on the specific game"
                                };
                                
                                console.log('Created minimal game data with iframe:', iframeContent.substring(0, 50) + '...');
                            } else {
                                throw secondError; // Re-throw if we couldn't extract iframe
                            }
                        }
                    }
                    
                    console.log('Using game data from URL parameter:', gameData);
                    
                    // Validate that we have the minimum required fields
                    if (!gameData.name) {
                        console.warn('Game data missing name field, trying API');
                        fetchGameDataWithRetry(gameId, 3);
                        return;
                    }
                    
                    populateGameData(gameData);
                } catch (error) {
                    console.error('Error parsing game data from URL:', error);
                    // Fall back to API request
                    fetchGameDataWithRetry(gameId, 3);
                }
            } else {
                // No game data in URL, try API request
                console.log('No game data in URL, trying API request');
                fetchGameDataWithRetry(gameId, 3);
            }
            
            // Set up iframe error handling
            const gameFallback = document.getElementById('game-fallback');
            const reloadButton = document.getElementById('reload-game');
            const newWindowLink = document.getElementById('new-window-link');
            const directIframeContainer = document.getElementById('direct-iframe-container');
            
            // Set up initial iframe event listeners
            setupIframeEventListeners(document.getElementById('game-iframe'));
            
            // Reload button functionality
            reloadButton.addEventListener('click', function() {
                // Show loading state on button
                const originalText = reloadButton.textContent;
                reloadButton.textContent = "Loading...";
                reloadButton.disabled = true;
                
                const directIframeContainer = document.getElementById('direct-iframe-container');
                
                // Check which display mode we're in
                if (directIframeContainer.style.display === 'block') {
                    // We're using the direct container, reload that
                    const iframeElement = directIframeContainer.querySelector('iframe');
                    if (iframeElement) {
                        const currentSrc = iframeElement.src;
                        iframeElement.src = '';
                        setTimeout(() => {
                            iframeElement.src = currentSrc;
                            
                            // Reset button state after a delay
                            setTimeout(() => {
                                reloadButton.textContent = originalText;
                                reloadButton.disabled = false;
                            }, 1000);
                        }, 200);
                    } else {
                        // No iframe found, try reloading the container
                        const currentHTML = directIframeContainer.innerHTML;
                        directIframeContainer.innerHTML = '';
                        setTimeout(() => {
                            directIframeContainer.innerHTML = currentHTML;
                            
                            // Reset button state after a delay
                            setTimeout(() => {
                                reloadButton.textContent = originalText;
                                reloadButton.disabled = false;
                            }, 1000);
                        }, 200);
                    }
                } else {
                    // Using the regular iframe
                    const gameIframe = document.getElementById('game-iframe');
                    if (gameIframe) {
                        const currentSrc = gameIframe.src;
                        
                        // For CrazyGames, try a special reload approach
                        if (currentSrc.includes('crazygames.com')) {
                            console.log('Reloading CrazyGames iframe with special approach');
                            
                            // Get the game slug
                            const slugMatch = currentSrc.match(/\/embed\/([^/?#]+)/);
                            if (slugMatch && slugMatch[1]) {
                                const gameSlug = slugMatch[1];
                                
                                // Create a new iframe to replace the old one
                                const newIframe = document.createElement('iframe');
                                newIframe.id = 'game-iframe';
                                newIframe.className = 'game-iframe';
                                newIframe.src = `https://www.crazygames.com/embed/${gameSlug}`;
                                newIframe.title = gameIframe.title || 'Game';
                                newIframe.allow = 'fullscreen; autoplay; gamepad *;';
                                newIframe.allowFullscreen = true;
                                newIframe.frameBorder = '0';
                                
                                // Replace the old iframe
                                gameIframe.parentNode.replaceChild(newIframe, gameIframe);
                                
                                // Set up event listeners for the new iframe
                                setupIframeEventListeners(newIframe);
                                
                                // Reset button state after a delay
                                setTimeout(() => {
                                    reloadButton.textContent = originalText;
                                    reloadButton.disabled = false;
                                }, 1000);
                            } else {
                                // Standard reload approach
                                gameIframe.src = '';
                                setTimeout(() => {
                                    gameIframe.src = currentSrc;
                                    
                                    // Reset button state after a delay
                                    setTimeout(() => {
                                        reloadButton.textContent = originalText;
                                        reloadButton.disabled = false;
                                    }, 1000);
                                }, 200);
                            }
                        } else {
                            // Standard reload approach
                            gameIframe.src = '';
                            setTimeout(() => {
                                gameIframe.src = currentSrc;
                                
                                // Reset button state after a delay
                                setTimeout(() => {
                                    reloadButton.textContent = originalText;
                                    reloadButton.disabled = false;
                                }, 1000);
                            }, 200);
                        }
                    } else {
                        // No iframe found
                        reloadButton.textContent = originalText;
                        reloadButton.disabled = false;
                    }
                }
                
                gameFallback.style.display = 'none';
                if (directIframeContainer.style.display === 'block') {
                    document.getElementById('game-iframe').style.display = 'none';
                    directIframeContainer.style.display = 'block';
                } else {
                    document.getElementById('game-iframe').style.display = 'block';
                }
            });
            
            // Function to show fallback content
            function showFallback() {
                const gameIframe = document.getElementById('game-iframe');
                if (gameIframe) {
                    gameIframe.style.display = 'none';
                }
                directIframeContainer.style.display = 'none';
                gameFallback.style.display = 'block';
            }
            
            // Set a timeout to check if the game is loaded
            setTimeout(function() {
                const gameIframe = document.getElementById('game-iframe');
                if (!gameIframe) return;
                
                try {
                    // If we can't access iframe content after timeout, check status
                    if (gameIframe.contentDocument === null) {
                        console.log('Timeout reached, checking iframe status');
                        
                        // For CrazyGames, don't show fallback immediately as they can take longer to load
                        if (gameIframe.src && gameIframe.src.includes('crazygames.com')) {
                            console.log('CrazyGames iframe detected, giving extra time to load');
                            // Give extra time for CrazyGames to load
                            setTimeout(() => {
                                // Only show fallback if the game is still not visible
                                if (gameIframe.offsetHeight === 0 || gameIframe.offsetWidth === 0) {
                                    showFallback();
                                }
                            }, 5000); // Extra 5 seconds
                        } else {
                            // For non-CrazyGames, check if iframe is empty
                            if (gameIframe.src === '' || gameIframe.src === 'about:blank') {
                                showFallback();
                            }
                        }
                    }
                } catch (e) {
                    // This is expected for cross-origin iframes
                    console.log('Cross-origin iframe detected (normal behavior)');
                }
            }, 5000);
            
            // Also check the direct iframe container if it's being used
            setTimeout(function() {
                if (directIframeContainer.style.display === 'block') {
                    const directIframe = directIframeContainer.querySelector('iframe');
                    if (!directIframe || directIframe.src === '' || directIframe.src === 'about:blank') {
                        console.error('Direct iframe container has issues');
                        
                        // Try auto-reload once for direct iframe container
                        if (!directIframeContainer.dataset.autoReloaded) {
                            console.log('Auto-reloading direct iframe container...');
                            directIframeContainer.dataset.autoReloaded = "true";
                            
                            // Store current HTML
                            const currentHTML = directIframeContainer.innerHTML;
                            
                            // Clear and reset HTML after a short delay
                            directIframeContainer.innerHTML = "";
                            setTimeout(() => {
                                directIframeContainer.innerHTML = currentHTML;
                            }, 200);
                        } else {
                            showFallback();
                        }
                    }
                }
            }, 5000);
            
            // Function to preload common game hosting domains
            function preloadDomains(domains) {
                domains.forEach(domain => {
                    // Create a link preconnect element
                    const link = document.createElement('link');
                    link.rel = 'preconnect';
                    link.href = `https://${domain}`;
                    document.head.appendChild(link);
                    
                    // Also add DNS-prefetch as fallback
                    const dnsPrefetch = document.createElement('link');
                    dnsPrefetch.rel = 'dns-prefetch';
                    dnsPrefetch.href = `https://${domain}`;
                    document.head.appendChild(dnsPrefetch);
                    
                    console.log(`Preloaded domain: ${domain}`);
                });
            }
        });
        
        // Function to set up iframe event listeners
        function setupIframeEventListeners(iframe) {
            if (!iframe) return;
            
            // Check if iframe loaded correctly
            iframe.addEventListener('load', function() {
                console.log('Iframe load event fired');
                
                // Hide the fallback if it was showing
                const gameFallback = document.getElementById('game-fallback');
                if (gameFallback) {
                    gameFallback.style.display = 'none';
                }
                iframe.style.display = 'block';
            });
            
            // Handle iframe errors
            iframe.addEventListener('error', function(e) {
                console.error('Game iframe failed to load:', e);
                const gameFallback = document.getElementById('game-fallback');
                if (gameFallback) {
                    const gameIframe = document.getElementById('game-iframe');
                    if (gameIframe) {
                        gameIframe.style.display = 'none';
                    }
                    const directIframeContainer = document.getElementById('direct-iframe-container');
                    if (directIframeContainer) {
                        directIframeContainer.style.display = 'none';
                    }
                    gameFallback.style.display = 'block';
                }
            });
        }
        
        // Function to fetch game data with retry mechanism
        async function fetchGameDataWithRetry(gameId, maxRetries) {
            let retries = 0;
            
            while (retries < maxRetries) {
                try {
                    await fetchGameData(gameId);
                    return; // Success, exit the retry loop
                } catch (error) {
                    retries++;
                    console.log(`Attempt ${retries}/${maxRetries} failed. ${retries < maxRetries ? 'Retrying...' : 'Giving up.'}`);
                    
                    if (retries >= maxRetries) {
                        showError(`Failed to load game data after ${maxRetries} attempts`);
                        break;
                    }
                    
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, retries - 1)));
                }
            }
        }
        
        // Function to fetch game data from API
        async function fetchGameData(gameId) {
            try {
                // Determine if we're in local development or production
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const apiUrl = isLocalDev ? `/api/games/${gameId}` : `https://relaxplayland.online/api/games/${gameId}`;
                
                console.log(`Fetching game data from: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn(`API returned non-JSON response: ${contentType}`);
                    
                    // Try to extract game data from URL parameters as a fallback
                    const urlParams = new URLSearchParams(window.location.search);
                    const gameDataParam = urlParams.get('data');
                    
                    if (gameDataParam) {
                        try {
                            // Use the same careful parsing approach as before
                            let gameData;
                            try {
                                gameData = JSON.parse(decodeURIComponent(gameDataParam));
                            } catch (decodeError) {
                                const fixedParam = gameDataParam
                                    .replace(/%5Cr%5Cn/g, '\\n')
                                    .replace(/%5C/g, '\\');
                                gameData = JSON.parse(decodeURIComponent(fixedParam));
                            }
                            
                            console.log('API returned non-JSON, using URL parameter data instead');
                            populateGameData(gameData);
                            return { success: true, game: gameData };
                        } catch (parseError) {
                            console.error('Failed to parse URL parameter data as fallback:', parseError);
                        }
                    }
                    
                    throw new Error(`Expected JSON response but got ${contentType}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load game data');
                }
                
                // Access the game data from the response
                populateGameData(data.game);
                return data; // Return the data for potential use by the caller
            } catch (error) {
                console.error('Error fetching game data:', error);
                
                // Check if we have game data in URL as a last resort
                const urlParams = new URLSearchParams(window.location.search);
                const gameDataParam = urlParams.get('data');
                
                if (gameDataParam && !document.getElementById('game-content').style.display === 'block') {
                    try {
                        // Try to parse the URL parameter as a last resort
                        let gameData;
                        try {
                            gameData = JSON.parse(decodeURIComponent(gameDataParam));
                        } catch (decodeError) {
                            const fixedParam = gameDataParam
                                .replace(/%5Cr%5Cn/g, '\\n')
                                .replace(/%5C/g, '\\');
                            gameData = JSON.parse(decodeURIComponent(fixedParam));
                        }
                        
                        console.log('API failed, using URL parameter data as last resort');
                        populateGameData(gameData);
                        return { success: true, game: gameData };
                    } catch (parseError) {
                        console.error('Failed to parse URL parameter data as last resort:', parseError);
                    }
                }
                
                // Let the retry mechanism handle the error
                throw error;
            }
        }
        
        // Function to populate the page with game data
        function populateGameData(game) {
            if (!game) {
                showError('Invalid game data received');
                return;
            }
            
            try {
                // Format game data for display
                const gameData = {
                    ...game,
                    // Add computed properties if they don't exist
                    gameUrl: game.iframe || game.gameUrl || `/public/games/${game.slug}/index.html`,
                    instructions: game.instructions || game.howToPlay || 'No instructions available.'
                };
                
                // Update page title and meta tags
                document.title = `${gameData.name} | RelaxPlayLand`;
                document.querySelector('meta[name="description"]').setAttribute('content', gameData.description || '');
                document.querySelector('meta[property="og:title"]').setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                document.querySelector('meta[property="og:description"]').setAttribute('content', gameData.description || '');
                document.querySelector('meta[name="twitter:title"]').setAttribute('content', `${gameData.name} | RelaxPlayLand`);
                document.querySelector('meta[name="twitter:description"]').setAttribute('content', gameData.description || '');
                
                // Update game content
                document.getElementById('game-title').textContent = gameData.name;
                document.getElementById('game-description').textContent = gameData.description || 'No description available.';
                document.getElementById('game-instructions').textContent = gameData.instructions;
                
                // Update game details
                document.getElementById('game-category').textContent = gameData.category || '-';
                
                // Update developer info
                if (gameData.developer) {
                    document.getElementById('game-developer').textContent = gameData.developer.name || '-';
                    const developerUrlElement = document.getElementById('game-developer-url').querySelector('a');
                    developerUrlElement.textContent = gameData.developer.website || gameData.developer.url || '-';
                    developerUrlElement.href = gameData.developer.website || gameData.developer.url || '#';
                }
                
                // Set iframe source - use iframe URL directly if available, or fallback to gameUrl
                let gameIframe = document.getElementById('game-iframe');
                const directIframeContainer = document.getElementById('direct-iframe-container');
                
                // Check if iframe data is an HTML string containing an iframe tag
                if (gameData.iframe && typeof gameData.iframe === 'string') {
                    console.log('Processing iframe data:', gameData.iframe.substring(0, 100) + '...');
                    
                    // First try direct HTML insertion approach
                    if (gameData.iframe.includes('<iframe')) {
                        try {
                            // Clean iframe HTML string - replace escaped quotes and backslashes
                            const cleanIframeHtml = gameData.iframe
                                .replace(/\\"/g, '"')
                                .replace(/\\'/g, "'")
                                .replace(/\\\\/g, "\\");
                            
                            console.log('Using direct iframe HTML insertion');
                            directIframeContainer.innerHTML = cleanIframeHtml;
                            
                            // Check if insertion was successful
                            const insertedIframe = directIframeContainer.querySelector('iframe');
                            if (insertedIframe) {
                                console.log('Successfully inserted iframe directly');
                                
                                // Hide the regular iframe and show the direct container
                                gameIframe.style.display = 'none';
                                directIframeContainer.style.display = 'block';
                                
                                // Update new window link
                                const newWindowLink = document.getElementById('new-window-link');
                                if (insertedIframe.src) {
                                    newWindowLink.href = insertedIframe.src;
                                }
                                
                                // Add extra height to container if needed
                                if (insertedIframe.height) {
                                    const height = parseInt(insertedIframe.height);
                                    if (!isNaN(height) && height > 0) {
                                        directIframeContainer.style.height = `${height}px`;
                                    }
                                }
                                
                                // Hide loading state and show content
                                document.getElementById('loading').style.display = 'none';
                                document.getElementById('game-content').style.display = 'block';
                                
                                return; // Exit early since we've successfully loaded the iframe
                            }
                        } catch (error) {
                            console.error('Error with direct iframe insertion:', error);
                            // Continue with fallback methods
                        }
                    }
                    
                    // Extract iframe src using regex as fallback
                    try {
                        const srcMatch = gameData.iframe.match(/src=["']([^"']+)["']/i);
                        if (srcMatch && srcMatch[1]) {
                            const iframeSrc = srcMatch[1].replace(/\\"/g, '"').replace(/\\\\/g, "\\");
                            console.log('Extracted iframe src using regex:', iframeSrc);
                            
                            // Set attributes for the iframe
                            gameIframe.allowFullscreen = true;
                            gameIframe.allow = "fullscreen; autoplay; clipboard-write; encrypted-media; gamepad; accelerometer; gyroscope; picture-in-picture";
                            gameIframe.frameBorder = "0";
                            gameIframe.src = iframeSrc;
                            
                            // Update new window link
                            const newWindowLink = document.getElementById('new-window-link');
                            newWindowLink.href = iframeSrc;
                            
                            // Show the regular iframe
                            gameIframe.style.display = 'block';
                            directIframeContainer.style.display = 'none';
                        } else {
                            // If no src found, try to use the iframe string directly as a URL
                            console.log('No iframe src found, trying to use string as URL');
                            gameIframe.src = gameData.iframe;
                        }
                    } catch (error) {
                        console.error('Error extracting iframe src:', error);
                        gameIframe.src = gameData.gameUrl || '';
                    }
                } else {
                    console.log('Using direct iframe URL:', gameData.gameUrl || '');
                    gameIframe.src = gameData.gameUrl || '';
                }
                
                gameIframe.title = gameData.name;
                
                // Add category and difficulty badges
                const badgesContainer = document.getElementById('game-badges');
                badgesContainer.innerHTML = '';
                
                if (gameData.category) {
                    const categoryBadge = document.createElement('span');
                    categoryBadge.className = 'badge bg-blue-100 text-blue-800';
                    categoryBadge.textContent = gameData.category;
                    badgesContainer.appendChild(categoryBadge);
                }
                
                // Hide loading state and show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error populating game data:', error);
                showError('Error displaying game content');
            }
        }
        
        // Function to show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorElement = document.getElementById('error-message');
            
            // Add more detailed error message
            const errorTitle = errorElement.querySelector('h2');
            const errorText = errorElement.querySelector('p');
            
            if (errorTitle && errorText) {
                errorTitle.textContent = 'Game Not Found';
                errorText.textContent = message || 'Sorry, we couldn\'t find the game you\'re looking for.';
            }
            
            // Add a button to try alternative loading method
            const returnLink = errorElement.querySelector('a');
            if (returnLink) {
                const gameId = new URLSearchParams(window.location.search).get('id');
                const fallbackButton = document.createElement('a');
                fallbackButton.className = 'mt-4 ml-4 inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors';
                fallbackButton.textContent = 'Try Alternative Loading';
                fallbackButton.href = `/games/${gameId}.html`;
                returnLink.parentNode.appendChild(fallbackButton);
            }
            
            errorElement.style.display = 'block';
            console.error(message);
            
            // Add debugging info
            const gameId = new URLSearchParams(window.location.search).get('id');
            console.log(`Attempted to load game with ID: ${gameId}`);
        }
    </script>
</body>
</html> 